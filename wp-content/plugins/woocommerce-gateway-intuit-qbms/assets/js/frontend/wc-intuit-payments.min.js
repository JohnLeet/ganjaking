"use strict";var _createClass=function(){function a(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,n){return t&&a(e.prototype,t),n&&a(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}!function(){jQuery(function(i){function e(){var n=this;_classCallCheck(this,e),this.params=window.wc_intuit_payments_params,i(document.body).on("sv_wc_payment_form_valid_payment_data",function(e,t){return n.init(e,t)}),i(document.body).on("checkout_error",function(e){return i("input[name=wc-"+n.params.id_dasherized+"-js-token]").val("")}),i(document.body).on("updated_checkout",function(){return n.handle_saved_payment_methods()})}return window.WC_Intuit_Payments_Payment_Form_Handler=window.SV_WC_Payment_Form_Handler_v5_11_4,i(document.body).trigger("wc_intuit_payments_payment_form_handler_loaded"),window.WC_Intuit_Payments_Tokenization_Handler=(_createClass(e,[{key:"init",value:function(e,t){var n;if(this.payment_form=t.payment_form,("intuit_payments_credit_card"===(n=this.payment_form.id)||"intuit_payments_echeck"===n)&&!this.payment_form.saved_payment_method_selected&&t.passed_validation)return!!this.has_token()||("intuit_payments_credit_card"===this.payment_form.id?this.tokenize_method("credit_card"):this.tokenize_method("echeck"),!1)}},{key:"tokenize_method",value:function(e){var t=this;return this.payment_form.block_ui(),e=this.get_request_data(e),this.log_request(e),i.ajax(this.params.api_url,{method:"POST",dataType:"json",contentType:"application/json",crossDomain:!0,data:JSON.stringify(e),success:function(e){return t.handle_response(e)},error:function(e){return t.handle_response(e.responseJSON)}})}},{key:"get_request_data",value:function(e){var t,n=i("input[id=wc-"+this.payment_form.id_dasherized+"-account-number]").val(),a=i("input[name=billing_first_name]").val()+" "+i("input[name=billing_last_name]").val(),r=i("#billing_country").val();return"credit_card"===e?(i("select[name=wc-"+this.payment_form.id_dasherized+"-test-case]").val()&&(a=i("select[name=wc-"+this.payment_form.id_dasherized+"-test-case]").val()),t=(e=i("input[name=wc-"+this.payment_form.id_dasherized+"-expiry]").payment("cardExpiryVal")).month.toString(),t={card:{expYear:e.year.toString(),expMonth:t=1===t.length?"0"+t:t,name:a.substring(0,30),cvc:i("input[id=wc-"+this.payment_form.id_dasherized+"-csc]").val(),number:n}},r&&(t.card.address={postalCode:i("input[name=billing_postcode]").val().substring(0,10),streetAddress:i("input[name=billing_address_1]").val().substring(0,30),country:r.substring(0,2)}),i("#billing_city").val()&&(t.card.address.city=i("#billing_city").val().substring(0,30)),i("#billing_state").val()&&2<=i("#billing_state").val().length&&(t.card.address.region=i("#billing_state").val().substring(0,20))):("checking"===(e=i("#wc-"+this.payment_form.id_dasherized+"-account-type").val())?e="PERSONAL_CHECKING":"savings"===e&&(e="PERSONAL_SAVINGS"),t={bankAccount:{name:a.substring(0,30),routingNumber:i("input[id=wc-"+this.payment_form.id_dasherized+"-routing-number]").val(),accountNumber:n,accountType:e}},r&&(t.bankAccount.country=r.substring(0,2)),i("input[name=billing_phone]").length&&(t.bankAccount.phone=i("input[name=billing_phone]").val().replace(/\D/g,""))),t}},{key:"handle_response",value:function(t){var n;return this.log_response(t),null!=t.value?(this.set_token(t.value),this.payment_form.form.submit()):(t.errors&&console.error(t.errors),n=[this.params.generic_error],window.errorMessages=t.errors,i(t.errors).each(function(e){e=t.errors[e];if(e.code&&e.moreInfo&&-1<i.inArray(e.code,["PMT-4000","PMT-4001","PMT-4002"]))return n.push(e.moreInfo)}),this.payment_form.render_errors(n),this.payment_form.unblock_ui())}},{key:"set_token",value:function(e){return i("input[name=wc-"+this.payment_form.id_dasherized+"-js-token]").val(e),e=i("input[id=wc-"+this.payment_form.id_dasherized+"-account-number]").val().slice(-4),i("input[name=wc-"+this.payment_form.id_dasherized+"-last-four]").val(e),e=i.payment.cardType(i("input[id=wc-"+this.payment_form.id_dasherized+"-account-number]").val()),i("input[name=wc-"+this.payment_form.id_dasherized+"-card-type]").val(e)}},{key:"has_token",value:function(){return i("input[name=wc-"+this.payment_form.id_dasherized+"-js-token]").val()}},{key:"handle_saved_payment_methods",value:function(){var t="js-sv-wc-payment-gateway-credit-card-form-csc";return i("input.js-wc-intuit-payments-credit-card-payment-token").change(function(){var e=i("#wc-intuit-payments-credit-card-credit-card-form");return i("input.js-wc-intuit-payments-credit-card-payment-token:checked").val()?(e.hide(),i("#wc-intuit-payments-credit-card-csc").removeClass(t)):(i("#wc-intuit-payments-credit-card-csc").addClass(t),e.show())})}},{key:"log_request",value:function(e){var t,n={};if(e.card){for(t in e.card)n[t]=e.card[t];n.number&&(n.number=n.number.replace(/\d(?=\d{4})/g,"*")),n.cvc&&(n.cvc=n.cvc.replace(/[0-9]/g,"*"))}if(e.bankAccount){for(t in e.bankAccount)n[t]=e.bankAccount[t];n.accountNumber&&(n.accountNumber=n.accountNumber.replace(/\d(?=\d{4})/g,"*")),n.routingNumber&&(n.routingNumber=n.routingNumber.replace(/[0-9]/g,"*"))}return this.log_data(n,"request")}},{key:"log_response",value:function(e){return this.log_data(e,"response")}},{key:"log_data",value:function(e,t){if(this.params.ajax_log)return t={action:"wc_"+this.payment_form.plugin_id+"_log_js_data",gateway_id:this.payment_form.id,security:this.params.ajax_log_nonce,type:t,data:e},i.ajax({url:this.params.ajax_url,data:t})}}]),e),window.wc_intuit_payments_tokenization_handler=new WC_Intuit_Payments_Tokenization_Handler})}.call(void 0);